<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cardápio Online Paróquia São Judas</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f1f8f4;text-align:center}
    h1{background:linear-gradient(90deg,#006400,#228B22);padding:15px;margin:0;font-size:22px;color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.2)}
    .menu{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;padding:20px}
    .item{background:#fff;padding:15px;border-radius:12px;box-shadow:0 3px 6px rgba(0,0,0,.15);transition:transform .2s}
    .item:hover{transform:scale(1.03)}
    .item h3{margin:5px 0;color:#006400}
    .item p{font-weight:bold;color:#444}
    .buttons{display:flex;justify-content:center;gap:10px;margin-top:10px}
    .item button{background:#228B22;color:#fff;border:none;padding:8px 12px;cursor:pointer;border-radius:6px;font-size:14px;flex:1;transition:background .2s}
    .item button:hover{background:#006400}
    .footer{position:fixed;bottom:0;left:0;width:100%;background:#fff8dc;display:flex;justify-content:space-between;align-items:center;padding:12px;border-top:2px solid #228B22;gap:10px;box-shadow:0 -2px 5px rgba(0,0,0,.1);z-index:10}
    .footer button{background:#daa520;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;transition:background .2s}
    .footer button:hover{background:#b8860b}
    .footer input{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;font-size:14px}
    #pix-area{margin:20px;padding:20px;background:#fff;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.2);display:none;margin-bottom:80px}
    #pix-area h2{color:#006400}
    textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:14px}
    .utils{display:none;margin-top:10px;gap:10px;justify-content:flex-end}
    .utils button{background:#e0e0e0;color:#333}
  </style>
</head>
<body>

  <h1>Cardápio Online Paróquia São Judas</h1>

  <div class="menu" id="menu">
    <div class="item">
      <h3>Macarrão</h3><p>R$ 10,00</p>
      <div class="buttons"><button onclick="addItem(10)">+</button><button onclick="removeItem(10)">-</button></div>
    </div>
    <div class="item">
      <h3>Bolo</h3><p>R$ 7,00</p>
      <div class="buttons"><button onclick="addItem(7)">+</button><button onclick="removeItem(7)">-</button></div>
    </div>
    <div class="item">
      <h3>Salgado</h3><p>R$ 6,00</p>
      <div class="buttons"><button onclick="addItem(6)">+</button><button onclick="removeItem(6)">-</button></div>
    </div>
    <div class="item">
      <h3>Doce</h3><p>R$ 5,00</p>
      <div class="buttons"><button onclick="addItem(5)">+</button><button onclick="removeItem(5)">-</button></div>
    </div>
    <div class="item">
      <h3>Refrigerante</h3><p>R$ 8,00</p>
      <div class="buttons"><button onclick="addItem(8)">+</button><button onclick="removeItem(8)">-</button></div>
    </div>
    <div class="item">
      <h3>Suco</h3><p>R$ 5,00</p>
      <div class="buttons"><button onclick="addItem(5)">+</button><button onclick="removeItem(5)">-</button></div>
    </div>
  </div>

  <div class="footer">
    <span id="total">Total: R$ 0,00</span>
    <input type="text" id="nomeCliente" placeholder="Digite seu nome" />
    <button onclick="finalizarPedido()">Finalizar Pedido</button>
  </div>

  <div id="pix-area">
    <h2>Finalize seu pagamento</h2>
    <p>Use o QR Code ou o código Pix abaixo:</p>
    <div id="qrcode"></div>
    <textarea id="pixCode" rows="4" readonly></textarea>
    <div class="utils" id="utils">
      <button onclick="exportarCSV()">Exportar CSV</button>
      <button onclick="limparLog()">Limpar log</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    let total = 0;

    function formatar(v){return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
    function addItem(p){total+=p;document.getElementById('total').innerText='Total: '+formatar(total);}
    function removeItem(p){if(total>=p){total-=p;document.getElementById('total').innerText='Total: '+formatar(total);}}

    // Sanear textos (remover acentos e caracteres fora do permitido)
    function sanitize(text, max){
      const s = text.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Za-z0-9 \-\.]/g,'').trim();
      return (max? s.slice(0,max): s);
    }

    // TLV helper
    function tlv(id, value){
      const len = value.length.toString().padStart(2,'0');
      return id + len + value;
    }

    // CRC16-CCITT (0x1021) usado no BR Code
    function crc16(str){
      let crc = 0xFFFF;
      for(let i=0;i<str.length;i++){
        crc ^= (str.charCodeAt(i) << 8);
        for(let j=0;j<8;j++){
          crc = (crc & 0x8000) ? ((crc<<1) ^ 0x1021) : (crc<<1);
          crc &= 0xFFFF;
        }
      }
      return crc.toString(16).toUpperCase().padStart(4,'0');
    }

    function gerarTxid(){
      const d=new Date();
      const tx="PSJ"+d.getFullYear().toString()
        +(d.getMonth()+1).toString().padStart(2,'0')
        +d.getDate().toString().padStart(2,'0')
        +d.getHours().toString().padStart(2,'0')
        +d.getMinutes().toString().padStart(2,'0')
        +d.getSeconds().toString().padStart(2,'0');
      // TXID do Pix aceita até 25 caracteres
      return tx.slice(0,25);
    }

    function montarPayloadPix({chavePix, nomeRecebedor, cidade, valor, txid}){
      // 00: Payload Format Indicator
      let payload = tlv('00','01');

      // 26: Merchant Account Information (GUI + chave)
      const gui = tlv('00','br.gov.bcb.pix'); // precisa ser minúsculo
      const chave = tlv('01', chavePix);
      payload += tlv('26', gui + chave);

      // 52: MCC, 53: Moeda, 54: Valor, 58: País, 59: Nome, 60: Cidade
      payload += tlv('52','0000');
      payload += tlv('53','986');
      payload += tlv('54', valor); // "10.00"
      payload += tlv('58','BR');
      payload += tlv('59', sanitize(nomeRecebedor, 25));
      payload += tlv('60', sanitize(cidade, 15));

      // 62: Additional Data Field Template (TXID)
      const adf = tlv('05', sanitize(txid,25));
      payload += tlv('62', adf);

      // 63: CRC16
      const semCRC = payload + '6304';
      const crc = crc16(semCRC);
      payload = semCRC + crc;

      return payload;
    }

    function finalizarPedido(){
      const nome = document.getElementById('nomeCliente').value.trim();
      if(total<=0){alert('Adicione pelo menos 1 item ao pedido.');return;}
      if(!nome){alert('Digite seu nome antes de finalizar o pedido.');return;}

      const chavePix = '03980793664'; // sua chave (CPF, CNPJ, e-mail, tel. ou aleatória)
      const nomeRecebedor = 'Paroquia Sao Judas';
      const cidade = 'Montes Claros';
      const valorStr = total.toFixed(2);
      const txid = gerarTxid();

      // Monta payload corretamente (TLV)
      const payload = montarPayloadPix({
        chavePix,
        nomeRecebedor,
        cidade,
        valor: valorStr,
        txid
      });

      // Mostra QR e código
      document.getElementById('pix-area').style.display='block';
      document.getElementById('pixCode').value = payload;
      document.getElementById('qrcode').innerHTML='';
      new QRCode(document.getElementById('qrcode'), { text: payload, width:200, height:200 });
      document.getElementById('pix-area').scrollIntoView({behavior:'smooth'});

      // Log local (localStorage)
      salvarLog({
        datahora: new Date().toISOString(),
        nomeCliente: nome,
        valor: valorStr,
        txid,
        payload
      });
      document.getElementById('utils').style.display='flex';
    }

    // ===== LOG EM CSV (LocalStorage) =====
    function salvarLog(reg){
      const chave='pedidos_paroquia_sj';
      const lista = JSON.parse(localStorage.getItem(chave) || '[]');
      lista.push(reg);
      localStorage.setItem(chave, JSON.stringify(lista));
    }

    function exportarCSV(){
      const chave='pedidos_paroquia_sj';
      const lista = JSON.parse(localStorage.getItem(chave) || '[]');
      if(!lista.length){alert('Nenhum pedido registrado ainda.');return;}
      const headers = ['datahora','nomeCliente','valor','txid','payload'];
      const linhas = [headers.join(';')].concat(
        lista.map(r => headers.map(h => String(r[h]).replace(/;/g, ',')).join(';'))
      );
      const csv = linhas.join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'pedidos_paroquia_sao_judas.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function limparLog(){
      if(confirm('Deseja realmente limpar o log local de pedidos?')){
        localStorage.removeItem('pedidos_paroquia_sj');
        alert('Log limpo.');
      }
    }
  </script>
</body>
</html>
