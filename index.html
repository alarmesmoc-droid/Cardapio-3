<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cardápio Online Paróquia São Judas</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f8f8; text-align: center; }
    h1 { color: #2c3e50; }
    .menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
    .item { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .item button { margin-top: 10px; padding: 8px 12px; border: none; border-radius: 8px; background: #3498db; color: white; cursor: pointer; }
    .item button:hover { background: #2980b9; }
    #total-container { position: fixed; bottom: 0; left: 0; right: 0; background: #2ecc71; color: white; padding: 15px; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
    #finalizar { background: #e67e22; padding: 10px 15px; border-radius: 8px; cursor: pointer; border: none; color: white; font-weight: bold; }
    #pix-container { margin-top: 20px; display: none; }
    #copyBtn { margin-top: 10px; padding: 10px 15px; background: #3498db; border: none; border-radius: 8px; color: white; cursor: pointer; }
    #copyBtn:hover { background: #2980b9; }
  </style>
</head>
<body>
  <h1>Cardápio Online Paróquia São Judas</h1>

  <div class="menu">
    <div class="item"><h3>Macarrão</h3><p>R$ 10,00</p><button onclick="adicionar(10)">Adicionar</button></div>
    <div class="item"><h3>Bolo</h3><p>R$ 7,00</p><button onclick="adicionar(7)">Adicionar</button></div>
    <div class="item"><h3>Salgado</h3><p>R$ 6,00</p><button onclick="adicionar(6)">Adicionar</button></div>
    <div class="item"><h3>Doce</h3><p>R$ 5,00</p><button onclick="adicionar(5)">Adicionar</button></div>
    <div class="item"><h3>Refrigerante</h3><p>R$ 8,00</p><button onclick="adicionar(8)">Adicionar</button></div>
    <div class="item"><h3>Suco</h3><p>R$ 5,00</p><button onclick="adicionar(5)">Adicionar</button></div>
    <div class="item"><h3>Água</h3><p>R$ 3,00</p><button onclick="adicionar(3)">Adicionar</button></div>
  </div>

  <div id="total-container">
    <span>Total: R$ <span id="total">0,00</span></span>
    <button id="finalizar" onclick="mostrarPix()">Finalizar Pedido</button>
  </div>

  <div id="pix-container">
    <h2>Pagamento via Pix</h2>
    <p>Código Copia e Cola:</p>
    <textarea id="pixCode" rows="5" cols="40" readonly></textarea><br>
    <button id="copyBtn" onclick="copiarPix()">Copiar Código Pix</button>
    <p>Ou escaneie o QR Code abaixo:</p>
    <div id="qrcode"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    let total = 0;

    function adicionar(valor) {
      total += valor;
      document.getElementById("total").textContent = total.toFixed(2).replace('.', ',');
    }

    // Função para calcular CRC16 exigido pelo padrão do BACEN
    function crc16(str) {
      let crc = 0xFFFF;
      for (let i = 0; i < str.length; i++) {
        crc ^= str.charCodeAt(i) << 8;
        for (let j = 0; j < 8; j++) {
          if ((crc & 0x8000) !== 0) {
            crc = (crc << 1) ^ 0x1021;
          } else {
            crc <<= 1;
          }
          crc &= 0xFFFF;
        }
      }
      return crc.toString(16).toUpperCase().padStart(4, '0');
    }

    function gerarPixPayload(valor) {
      const chave = "03980793664"; // chave pix
      const nome = "Avilo Fonseca";
      const cidade = "Montes Claros";
      const valorFormatado = valor.toFixed(2);

      let payload =
        "000201" + // Payload format
        "010212" + // Transação
        "26" + (4 + 14 + chave.length).toString().padStart(2, '0') + "0014BR.GOV.BCB.PIX01" + chave +
        "52040000" + // Merchant Category Code
        "5303986" +  // Moeda BRL
        "54" + valorFormatado.length.toString().padStart(2, '0') + valorFormatado +
        "5802BR" + 
        "59" + nome.length.toString().padStart(2, '0') + nome +
        "60" + cidade.length.toString().padStart(2, '0') + cidade +
        "62070503***" +
        "6304";

      // Adiciona o CRC16 no final
      const crc = crc16(payload);
      return payload + crc;
    }

    function mostrarPix() {
      if (total === 0) {
        alert("Adicione ao menos 1 produto!");
        return;
      }

      const payload = gerarPixPayload(total);
      document.getElementById("pixCode").value = payload;
      document.getElementById("pix-container").style.display = "block";

      document.getElementById("qrcode").innerHTML = "";
      QRCode.toCanvas(document.createElement("canvas"), payload, { width: 200 }, function (err, canvas) {
        if (!err) {
          document.getElementById("qrcode").appendChild(canvas);
        }
      });
    }

    function copiarPix() {
      const pixCode = document.getElementById("pixCode");
      navigator.clipboard.writeText(pixCode.value)
        .then(() => alert("Código Pix copiado com sucesso!"))
        .catch(() => alert("Erro ao copiar o código Pix"));
    }
  </script>
</body>
</html>
